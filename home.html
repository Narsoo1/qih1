<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QIH home</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-body: #1b1b1b;
  --text-main: #f1f1f1;
  --bg-header: #232323;
  --box-color: #2a2a2a;
  --hover-box: #383838;
  --border-line: #3d3d3d;
  --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.4);
}

body.light {
  --bg-body: #f7f7f7;
  --text-main: #1f2937;
  --bg-header: #ffffff;
  --box-color: #ffffff;
  --hover-box: #f0f0f0;
  --border-line: #d1d5db;
  --shadow-soft: 0 2px 6px rgba(0, 0, 0, 0.08);
}

/* RESET */
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  transition: background-color 0.3s ease, color 0.3s ease;
  -webkit-tap-highlight-color: transparent;
}

* {
  box-shadow: none !important;
  outline: none;
}

/* HEADER */
header {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 60px;
  background-color: var(--bg-header);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid var(--border-line);
  z-index: 10;
}

/* LOGO */
.logo {
  font-family: 'Orbitron', sans-serif;
  font-weight: 600;
  font-size: 22px;
  letter-spacing: 2px;
  background: linear-gradient(90deg, #60a5fa, #3b82f6, #60a5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.menu-btn {
  background: none;
  border: none;
  font-size: 25px;
  color: var(--text-main);
  cursor: pointer;
  outline: none;
}

/* CHAT LIST */
.chat-list {
  padding: 70px 16px 16px;
}

.chat-item {
  background-color: var(--box-color);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 12px;
  cursor: pointer;
  box-shadow: var(--shadow-soft);
  transition: background-color 0.3s ease;
}

.chat-item:hover {
  background-color: var(--hover-box);
}

.chat-name {
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: white;
}

.chat-name > div {
  display: flex;
  align-items: center;
  gap: 8px;
}

.chat-status.online {
  color: #10b981;
}
.chat-status.offline {
  color: #6b7280;
}

.chat-last {
  font-size: 14px;
  color: #cbd5e1;
  margin-top: 4px;
}

.badge {
  background-color: red;
  color: white;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 12px;
}

/* POPUP */
.popup, .search-popup {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background-color: var(--bg-body);
  display: none;
  flex-direction: column;
  z-index: 80;
}

.popup-header, .search-header {
  height: 60px;
  background-color: var(--bg-header);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid var(--border-line);
}

.popup-title {
  font-family: 'Orbitron', sans-serif;
  font-weight: 600;
  font-size: 22px;
  letter-spacing: 2px;
  background: linear-gradient(90deg, #60a5fa, #3b82f6, #60a5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* POPUP BODY */
.popup-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  padding-top: 40px;
  gap: 20px;
  padding-left: 16px;
  padding-right: 16px;
}

.popup-body button {
  background-color: var(--box-color);
  color: var(--text-main);
  border: none;
  padding: 12px;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  box-shadow: var(--shadow-soft);
  transition: background-color 0.3s ease;
}
.popup-body button:hover {
  background-color: var(--hover-box);
}

/* FOOTER */
.popup-footer {
  padding: 16px;
  display: flex;
  justify-content: center;
  gap: 20px;
  border-top: 1px solid var(--border-line);
}
.popup-footer a {
  color: gray;
  font-size: 20px;
}

/* SEARCH */
#searchInput {
  width: 100%;
  margin: 16px 0 8px 0;
  padding: 12px 16px;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  background-color: var(--bg-header);
  color: var(--text-main);
  box-shadow: var(--shadow-soft);
  box-sizing: border-box;
}
#searchInput::placeholder {
  color: #9ca3af;
}
#searchInput:focus {
  outline: none;
  box-shadow: 0 0 0 2px #3b82f6;
}

#searchResults {
  margin-top: 12px;
  padding: 0 16px;
}
.item {
  background-color: var(--box-color);
  padding: 12px;
  border-radius: 6px;
  color: var(--text-main);
  margin-bottom: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.item:hover {
  background-color: var(--hover-box);
}

/* CONFIRM */
#customConfirm {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
  backdrop-filter: blur(5px);
}
.confirm-box {
  background-color: var(--box-color);
  color: var(--text-main);
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  width: 90%;
  max-width: 300px;
  box-shadow: var(--shadow-soft);
}
.confirm-buttons {
  margin-top: 16px;
  display: flex;
  justify-content: space-between;
  gap: 12px;
}
.confirm-buttons button {
  padding: 8px 16px;
  background: var(--hover-box);
  border: none;
  border-radius: 4px;
  color: var(--text-main);
  cursor: pointer;
  flex: 1;
}

/* FORCE COLOR TEMA */
body.light, body.light * {
  color: var(--text-main) !important;
}
body:not(.light), body:not(.light) * {
  color: var(--text-main) !important;
}
#archiveConfirm {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
  backdrop-filter: blur(5px);
}

#archiveConfirm .confirm-box {
  background-color: var(--box-color);
  color: var(--text-main);
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  width: 90%;
  max-width: 300px;
  box-shadow: var(--shadow-soft);
}

#archiveConfirm .confirm-buttons {
  margin-top: 16px;
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

#archiveConfirm .confirm-buttons button {
  padding: 8px 16px;
  background: var(--hover-box);
  border: none;
  border-radius: 4px;
  color: var(--text-main);
  cursor: pointer;
  flex: 1;
}
</style>
</head>
<body>

<header>
  <div class="logo">QIH</div>
  <button id="menuBtn" class="menu-btn"><i class="fas fa-bars"></i></button>
</header>

<div id="chatHistory" class="chat-list">
   <div style="color:gray">sabar!</div>
</div>

<!-- Menu PopUp -->
<div id="menuPopup" class="popup">
  <div class="popup-header">
    <div class="popup-title">menu</div>
    <button id="closePopup" class="menu-btn"><i class="fas fa-times"></i></button>
  </div>
  <div class="popup-body">
    <button id="searchUserBtn">Cari Username</button>
    <button id="archiveBtn">Arsip Chat</button>
    <button id="themeToggleBtn">oreo</button>
    <button id="logoutBtn">Logout</button>
  </div>
  <div class="popup-footer">
    <a href="https://instagram.com/qih_stark" target="_blank"><i class="fab fa-instagram"></i></a>
    <a href="https://x.com/faqihhm_" target="_blank"><i class="fab fa-twitter"></i></a>
  </div>
</div>

<!-- Popup Pencarian Username -->
<div id="searchPopup" class="search-popup">
  <div class="search-header">
    <div class="popup-title">Username</div>
    <button id="closeSearchPopup" class="menu-btn"><i class="fas fa-times"></i></button>
  </div>
  <input id="searchInput" type="text" placeholder="Cari username..." />
  <div id="searchResults"></div>
</div>

<!-- Popup Konfirmasi Hapus dan arsip🤡-->
<div id="customConfirm">
  <div class="confirm-box">
    <div id="confirmMessage">gue voter 05🤡</div>
    <div class="confirm-buttons">
      <button id="confirmDelete" style="background-color:#ef4444">Hapus</button>
      <button id="confirmArchive" style="background-color:#facc15; color:black;">Arsipkan</button>
      <button id="confirmCancel">Batal</button>
    </div>
  </div>
</div>


<!-- Popup Arsip -->
<div id="archivePopup" class="search-popup">
  <div class="search-header">
    <div class="popup-title">Arsip Chat</div>
    <button id="closeArchivePopup" class="menu-btn"><i class="fas fa-times"></i></button>
  </div>

  <!-- Konten Arsip -->
  <div id="archiveContent" style="padding: 16px;">
    <div style="color:gray">sabar!</div>
  </div>

<!-- Popup Konfirmasi Arsip -->
<div id="archiveConfirm" style="display: none;" class="confirm-box-wrapper">
  <div class="confirm-box">
    <div id="archiveConfirmMessage">gue voter 05🦔</div>
    <div class="confirm-buttons">
      <button id="btnDeleteArchive" style="background-color: #ef4444;">Hapus</button>
      <button id="btnUnarchive" style="background-color: #facc15; color: black;">Keluarkan</button>
      <button id="btnCancelArchive">Batal</button>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDocs, getDoc, query, where,
  setDoc, deleteDoc, updateDoc, arrayRemove
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

// Firebase setup
const app = initializeApp({
  apiKey: "AIzaSyBgZX_GKkekzJ8KwxLaAsZiDKm8moTuWAA",
  authDomain: "room-chat-4f487.firebaseapp.com",
  projectId: "room-chat-4f487"
});

const auth = getAuth(app);
const db = getFirestore(app);

// Elemen
const chatHistory = document.getElementById("chatHistory");
const menuBtn = document.getElementById("menuBtn");
const closePopup = document.getElementById("closePopup");
const menuPopup = document.getElementById("menuPopup");
const themeToggleBtn = document.getElementById("themeToggleBtn");
const logoutBtn = document.getElementById("logoutBtn");
const searchUserBtn = document.getElementById("searchUserBtn");
const searchPopup = document.getElementById("searchPopup");
const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");
const archiveBtn = document.getElementById("archiveBtn");
const archivePopup = document.getElementById("archivePopup");
const archiveContent = document.getElementById("archiveContent");
const closeSearchPopup = document.getElementById("closeSearchPopup");
const customConfirm = document.getElementById("customConfirm");
const confirmDelete = document.getElementById("confirmDelete");
const confirmArchive = document.getElementById("confirmArchive");
const confirmCancel = document.getElementById("confirmCancel");
const archiveConfirm = document.getElementById("archiveConfirm");
const btnDeleteArchive = document.getElementById("btnDeleteArchive");
const btnUnarchive = document.getElementById("btnUnarchive");
const btnCancelArchive = document.getElementById("btnCancelArchive");

let currentUsername = "";
let selectedChatId = null;
let selectedArchivedChatId = null;

// 🔄 Tema
themeToggleBtn.onclick = () => {
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
};
(function applyTheme() {
  if (localStorage.getItem("theme") === "light") document.body.classList.add("light");
})();

// 🔓 Menu
menuBtn.onclick = () => menuPopup.style.display = "flex";
closePopup.onclick = () => menuPopup.style.display = "none";
logoutBtn.onclick = () => signOut(auth).then(() => location.href = "login.html");

// 🔍 Cari Username
searchUserBtn.onclick = () => {
  searchPopup.style.display = "block";
  searchInput.focus();
};
closeSearchPopup.onclick = () => {
  searchPopup.style.display = "none";
  searchInput.value = "";
  searchResults.innerHTML = "";
};
searchInput.oninput = async () => {
  const val = searchInput.value.trim().toLowerCase();
  searchResults.innerHTML = "";
  if (!val) return;

  const q = query(
    collection(db, "users"),
    where("username", ">=", val),
    where("username", "<=", val + "\uf8ff")
  );
  const snap = await getDocs(q);
  if (searchInput.value.trim().toLowerCase() !== val) return;
  if (snap.empty) {
    searchResults.innerHTML = "<div style='color:gray;padding:10px'>Username tidak ditemukan</div>";
    return;
  }

  const seen = new Set();
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const name = data.username;
    if (seen.has(name)) return;
    seen.add(name);

    const div = document.createElement("div");
    div.className = "item";
    div.textContent = name === currentUsername ? `${name} (Itu kamu!)` : name;
    if (name === currentUsername) div.style.color = "#facc15";
    div.onclick = async () => {
      const chatId = [currentUsername, name].sort().join("_");
      const chatRef = doc(db, "chats", chatId);
      const exists = await getDoc(chatRef);
      if (!exists.exists()) {
        await setDoc(chatRef, {
          createdAt: Date.now(),
          lastMessage: "",
          lastTimestamp: 0,
          users: [currentUsername, name]
        });
      }
      localStorage.setItem("chatWith", name);
      localStorage.setItem("chatId", chatId);
      location.href = "chat.html";
    };
    searchResults.appendChild(div);
  });
};

// 🔐 Login check + load chat
onAuthStateChanged(auth, async user => {
  if (!user || !user.emailVerified) return location.href = "login.html";
  const userDoc = await getDoc(doc(db, "users", user.uid));
  currentUsername = userDoc.exists() ? userDoc.data().username.toLowerCase() : user.email.split("@")[0];
  await setDoc(doc(db, "status", user.uid), { state: "online", last_changed: Date.now() });
  loadChats();
});

// 🔁 Load chat utama
async function loadChats() {
  const snap = await getDocs(collection(db, "chats"));
  const chats = [];
  for (const docSnap of snap.docs) {
    const data = docSnap.data();
    if (!data.users?.includes(currentUsername)) continue;
    const archived = data.archivedBy || [];
    if (archived.includes(currentUsername)) continue;

    const other = data.users.find(u => u !== currentUsername);
    const userSnap = await getDocs(query(collection(db, "users"), where("username", "==", other)));
    if (userSnap.empty) continue;
    const otherUID = userSnap.docs[0].id;
    const statusSnap = await getDoc(doc(db, "status", otherUID));
    const online = statusSnap.exists() && statusSnap.data().state === "online";
    const lastTime = data.lastTimestamp || data.createdAt || 0;
    const lastMsg = data.lastMessage?.trim() || "(Belum ada pesan)";
    const readStatus = data.readStatus || {};
    const unread = lastTime > (readStatus[currentUsername] || 0) ? 1 : 0;

    chats.push({
      id: docSnap.id,
      name: other,
      lastMessage: lastMsg,
      lastTimestamp: lastTime,
      online,
      unreadCount: unread
    });
  }
  chats.sort((a, b) => b.lastTimestamp - a.lastTimestamp);
  renderChats(chats);
}

// ✅ Render chat + tekan lama
function renderChats(list) {
  chatHistory.innerHTML = "";
  for (const c of list) {
    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerHTML = `
      <div class="chat-name">
        <span>${c.name}</span>
        <div>
          ${c.unreadCount > 0 ? `<span class="badge">${c.unreadCount}</span>` : ""}
          <span class="chat-status ${c.online ? "online" : "offline"}">${c.online ? "●" : "○"}</span>
        </div>
      </div>
      <div class="chat-last">${c.lastMessage}</div>
    `;
    enableLongPress(div, c.id, c.name);
    chatHistory.appendChild(div);
  }
}

function enableLongPress(div, chatId, chatName) {
  let timer, isLongPress = false;

  div.addEventListener("click", () => {
    if (!isLongPress) {
      localStorage.setItem("chatWith", chatName);
      localStorage.setItem("chatId", chatId);
      location.href = "chat.html";
    }
  });

  const start = () => {
    isLongPress = false;
    timer = setTimeout(() => {
      isLongPress = true;
      selectedChatId = chatId;
      customConfirm.style.display = "flex";
    }, 600);
  };

  const cancel = () => clearTimeout(timer);

  div.addEventListener("mousedown", start);
  div.addEventListener("touchstart", start);
  div.addEventListener("mouseup", cancel);
  div.addEventListener("mouseleave", cancel);
  div.addEventListener("touchend", cancel);
}

// ✅ Konfirmasi
confirmCancel.onclick = () => {
  customConfirm.style.display = "none";
  selectedChatId = null;
};

// ✅ Tombol hapus
confirmDelete.onclick = async () => {
  if (!selectedChatId) return;
  const msgRef = collection(db, `chats/${selectedChatId}/messages`);
  const snap = await getDocs(msgRef);
  await Promise.all(snap.docs.map(doc => deleteDoc(doc.ref)));
  await deleteDoc(doc(db, "chats", selectedChatId));
  customConfirm.style.display = "none";
  selectedChatId = null;
  loadChats();
};

// ✅ Tombol arsip
confirmArchive.onclick = async () => {
  if (!selectedChatId) return;
  const chatRef = doc(db, "chats", selectedChatId);
  await updateDoc(chatRef, {
    archivedBy: [currentUsername]
  });
  customConfirm.style.display = "none";
  selectedChatId = null;
  loadChats();
};

// 🔘 Arsip
archiveBtn.onclick = () => {
  archivePopup.style.display = "block";
  loadArchivedChats();
};
document.getElementById("closeArchivePopup").onclick = () => {
  archivePopup.style.display = "none";
};

// 🔁 Load arsip
async function loadArchivedChats() {
  const snap = await getDocs(collection(db, "chats"));
  const archivedChats = [];
  for (const docSnap of snap.docs) {
    const data = docSnap.data();
    if (!data.users.includes(currentUsername)) continue;
    const archived = data.archivedBy || [];
    if (!archived.includes(currentUsername)) continue;

    const other = data.users.find(u => u !== currentUsername);
    const userSnap = await getDocs(query(collection(db, "users"), where("username", "==", other)));
    if (userSnap.empty) continue;
    const otherUID = userSnap.docs[0].id;
    const statusSnap = await getDoc(doc(db, "status", otherUID));
    const online = statusSnap.exists() && statusSnap.data().state === "online";
    const lastMsg = data.lastMessage?.trim() || "(Belum ada pesan)";
    archivedChats.push({
      id: docSnap.id,
      name: other,
      lastMessage: lastMsg,
      online
    });
  }
  renderArchivedChats(archivedChats);
}

function renderArchivedChats(list) {
  archiveContent.innerHTML = "";
  if (list.length === 0) {
    archiveContent.innerHTML = "<div style='color:gray'>Belum ada chat yang diarsipkan.</div>";
    return;
  }
  for (const c of list) {
    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerHTML = `
      <div class="chat-name">
        <span>${c.name}</span>
        <span class="chat-status ${c.online ? "online" : "offline"}">${c.online ? "●" : "○"}</span>
      </div>
      <div class="chat-last">${c.lastMessage}</div>
    `;
    enableLongPressArchive(div, c.id, c.name);
    archiveContent.appendChild(div);
  }
}

// ✅ Long press arsip
function enableLongPressArchive(div, chatId, chatName) {
  let timer, isLongPress = false;

  div.addEventListener("click", () => {
    if (!isLongPress) {
      localStorage.setItem("chatWith", chatName);
      localStorage.setItem("chatId", chatId);
      location.href = "chat.html";
    }
  });

  const start = () => {
    isLongPress = false;
    timer = setTimeout(() => {
      isLongPress = true;
      selectedArchivedChatId = chatId;
      archiveConfirm.style.display = "flex";
    }, 600);
  };

  const cancel = () => clearTimeout(timer);

  div.addEventListener("mousedown", start);
  div.addEventListener("touchstart", start);
  div.addEventListener("mouseup", cancel);
  div.addEventListener("mouseleave", cancel);
  div.addEventListener("touchend", cancel);
}

// ✅ Tombol ars
